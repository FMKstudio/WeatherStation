<html>
	<head>
		<meta http-equiv = 'content-type' content = 'text/html; charset = utf-8' />
		<title>Wifi Clock. Time</title>
		<style>
			body, td
			{
				font-family:tahoma,arial,helvetica,sans-serif;
				border: 0px solid #333;
				padding: 5px;
				text-align:center;
			}
			table.t td.h
			{
				background-color:#C9C9C0;
				font-size:12px;
				font-weight:bold;
				text-align:center;
			}
			table.t td
			{
				background-color:#E2E2DB;
				font-size:12px;
				text-align:center;
			}
			input
			{
				text-align:center;
			}
			option
			{
				text-align:center;
			}
			.menu
			{
				list-style-type: none;
				padding: 1px;
			}
			.menu > li 
			{
				float: left;
				margin-right: 10px;
			}
			.menu > li > a 
			{
				color: blue;
				padding: 2px;
			}
			.menu > li:hover > a 
			{
				color: black;
				text-decoration: none;
				border-radius: 5px 5px 0 0;
				box-shadow: 0 0 7px 0 rgba(0,0,0,0.6);
			}
			/* Этот стиль должен убирать серую полосу */
			.menu > li:hover > a:before 
			{
				content:'';
				position: absolute;
				bottom: -5px; left: 0;
				width: 100%;
				height: 7px;
				background: white;
				z-index: 5;
				cursor: pointer;
			}
			.menu-inner
			{
				display: none;
			}
			.menu > li:hover > .menu-inner
			{
				display: block;
				background-color: white; /* обязательно, зарисовываем тень */
				position: absolute;
				left: 0;
				top: 22px; /* подняли блок немного вверх */
				box-shadow: 0 0 7px 0 rgba(0,0,0,0.6);
				width: 120px;
				padding: 3px;
			}
			/* Стили для ниспадающего меню */
			.menu-inner > li
			{
				padding: 2px 0;
			}
			.menu-inner > li:hover
			{
				background-color: blue;
			}
			.menu-inner > li:hover > a
			{
				color: white;
				padding: 2px;
				text-decoration: none;
			}
		</style>
	</head>
  
	<body onload='loadValues();'>

		<ul class="menu">
			<li><a href="#">Menu</a>
				<ul class="menu-inner">
					<li><a href='time.htm'>Time</a></li>
					<li><a href='wifi.htm'>WiFi</a></li>
					<li><a href='gpio.htm'>GPIO</a></li>
					<li><a href='disp.htm'>Display</a></li>
					<li><a href='sens.htm'>Sensor</a></li>
					<li><a href='thermo.htm'>Thermo</a></li>
					<li><a href='news.htm'>News</a></li>
				</ul>
			</li>
			<li><a href='/update'>Update</a></li>
			<li><a href='/edit'>Edit</a></li>
			<li><a href='/exit'>Restart</a></li>
			<li style='float: none; visibility: hidden;'>.</li>
		 </ul>
		
		<table class='t' align="left">
			<tr>
			  <td  colspan='2' class='h'><output id='cur_time'></output></td>
			</tr>
			<tr>
				<td colspan='2'>Время
					<input type='text' maxlength='2' size='1' id='hour' name='hour'/>&nbsp;:&nbsp;
					<input type='text' maxlength='2' size='1' id='min'  name='min' />
				</td>
			</tr>
			<tr>
				<td colspan='2'>Дата
					<input type='text' maxlength='2' size='1' id='day'  name='day'  style='text-align:center;'  />&nbsp;/&nbsp;
					<input type='text' maxlength='2' size='1' id='mon'  name='mon'  style='text-align:center;'  />&nbsp;/&nbsp;
					<input type='text' maxlength='4' size='1' id='year' name='year' style='text-align:center;' />
				</td>
			</tr>
			<tr>
				<td  colspan='2' ><button onclick='set_time();'>Установить</button></td>
			</tr>
			<tr>
				<td colspan='2'></td>
			</tr>
			<tr>
				<td  colspan='2' ><button onclick='time_ntp();'>Время по интернету</button></td>
			</tr>
			<tr>
				<td colspan='2'></td>
			</tr>

			<tr>
				<td  colspan='2' class='h'>Настройки будильников</td>
			</tr>
  		<tr>
				<td colspan='2'>&nbsp; N: &nbsp;
				<select id='anum' name='anum' onchange='sel_anum();'>
					<option value = '0'>0</option>
					<option value = '1'>1</option>
					<option value = '2'>2</option>
					<option value = '3'>3</option>
					<option value = '4'>4</option>
					<option value = '5'>5</option>
					<option value = '6'>6</option>
				</select>
				&nbsp; Когда: &nbsp;
				<select id='atyp' name='atyp' onchange='sel_atyp();'>
					<option value = '0'>Отключен</option>
					<option value = '1'>Ежедневно</option>
					<option value = '2'>По рабочим</option>
					<option value = '3'>По выходным</option>
					<option value = '4'>Разово</option>
				</select>
				&nbsp; Сработает в: &nbsp;
				<input type='number' size='1' maxlength='2' min='0' max='23' id='ahour' name='ahour' />
				&nbsp;:&nbsp;
				<input type='number' size='1' maxlength='2' min='0' max='59' id='amin'  name='amin'/></td>
			</tr>
			<tr>
				<td colspan='2'>&nbsp; Экшн: &nbsp;
				<select id='aon' name='aon' onchange='sel_aact();'>
					<option value = '0'>Сыграет  мелодию</option>
					<option value = '1'>Включит  ночной режим</option>
					<option value = '2'>Выключит ночной режим</option>
					<option value = '3'>Включит  дисплей</option>
					<option value = '4'>Выключит дисплей</option>
					<option value = '5'>Включит  радио</option>
					<option value = '6'>Выключит радио</option>
				</select>
				&nbsp; Мелодия: &nbsp;
				<select id='amel' name='amel'>
					<option value = '0' >The Simpsons</option>
					<option value = '1' >Indiana</option>
					<option value = '2' >Entertainer</option>
					<option value = '3' >Looney</option>
					<option value = '4' >Bond</option>
					<option value = '5 '>MASH</option>
					<option value = '6' >StarWars</option>
					<option value = '7' >GoodBad</option>
					<option value = '8' >TopGun</option>
					<option value = '9' >A-Team</option>
					<option value = '10'>Flinstones</option>
					<option value = '11'>Jeopardy</option>
					<option value = '12'>MahnaMahna</option>
					<option value = '13'>MissionImpossible</option>
					<option value = '14'>KnightRider</option>
				</select></td>
			</tr>
			<tr>
				<td  colspan='2' class='h'>Актуальный будильник&nbsp;
				<output id='act_hour' name='act_hour'></output>
				&nbsp;:&nbsp;
				<output id='act_min'  name='act_min'></output>
				</td>
			</tr>
			<tr>
				<td colspan='2' class='h'>Опции для часов</td>
			</tr>
 			<tr>
				<td>Часовой пояс           </td><td><input type='text' size='3' id='tzone' name='tzone'/></td>
			</tr>
			<tr>
				<td>Автокоррекция через NTP</td><td><input type='checkbox' id='acorr' name='acorr'/></td>
			</tr>
			<tr>
				<td>12 часовой формат      </td><td><input type='checkbox' id='upm'   name='upm'  /></td>
			</tr>
				<tr><td>Сигнал каждый час  </td><td><input type='checkbox' id='ehb'   name='ehb'  /></td>
			</tr>
				<tr><td>Ночной режим</td>
				<td>с&nbsp;   <input type='text' maxlength='2' size='1' id='nmstart' name='nmstart'/>
				&nbsp;до&nbsp;<input type='text' maxlength='2' size='1' id='nmstop'  name='nmstop' /></td>
			</tr>
			<tr>
				<td>Тип RTC</td>
				<td><select id='rtyp' name='rtyp'>
					<option value = '0'> Не использовать RTC </option>
					<option value = '1'> DS3231 </option>
					<option value = '2'> DS1302 </option>
					<option value = '3'> DS1307 </option>
				</select></td>
			</tr>
			<tr>
				<td>Адрес NTP Сервера 1</td><td><input type='text' maxlength='17' size='17' id='antp1' name='antp1'/></td>
			</tr>
			<tr>
				<td>Адрес NTP Сервера 2</td><td><input type='text' maxlength='17' size='17' id='antp2' name='antp2'/></td>
			</tr>
			<tr>
				<td>Адрес NTP Сервера 3</td><td><input type='text' maxlength='17' size='17' id='antp3' name='antp3'/></td>
			</tr>

			<tr>
				<td colspan='2' ><button onclick='set_time_2();'>Записать</button></td>
			</tr>
		</table>
  
		<script>
			function loadValues()
			{
				var xh = new XMLHttpRequest();
				xh.open("GET", "/jtime1", true);
				xh.send(null);
				xh.onreadystatechange = function()
				{
					if (this.readyState == 4 && this.status == 200) 
					{
						var res = JSON.parse(xh.responseText);
						document.getElementById('hour').value = res.hour;
						document.getElementById('min').value  = res.min;
						document.getElementById('day').value  = res.day;
						document.getElementById('mon').value  = res.month;
						document.getElementById('year').value = res.year;
					}
				}

				var xh2 = new XMLHttpRequest();
				xh2.open("GET", "/jtime2", true);
				xh2.send(null);
				xh2.onreadystatechange =  function()
				{
					if (this.readyState == 4 && this.status == 200) 
					{
						var res = JSON.parse(xh2.responseText);
						document.getElementById('tzone').value = res.tzon;
						document.getElementById('acorr').checked = res.acor;
						document.getElementById('upm').checked = res.uspm;
						document.getElementById('nmstart').value = res.nstr;
						document.getElementById('nmstop').value = res.nend;
						document.getElementById('ehb').checked = res.evhb;
						document.getElementById('rtyp').value = res.trts;
						document.getElementById('antp1').value = res.antp1;
						document.getElementById('antp2').value = res.antp2;
						document.getElementById('antp3').value = res.antp3;
					}
				} 

				var num = document.getElementById('anum').value;

				var xh1 = new XMLHttpRequest();
				xh1.open("GET", "/jalarm", true);
				xh1.send(null);
				xh1.onreadystatechange = function()
				{
					if (this.readyState == 4 && this.status == 200) 
					{
						var res1 = JSON.parse(xh1.responseText);
						document.getElementById('atyp'  ).value = res1.al[num][0];
			  		document.getElementById('ahour' ).value = res1.al[num][1];
		  			document.getElementById('amin'  ).value = res1.al[num][2];
	  				document.getElementById('amel'  ).value = res1.al[num][3];
						document.getElementById('aon'   ).value = res1.al[num][4];

						sel_atyp();
						sel_aact();      		
					}
				}
			}
/////////////////////////////////////////////////////////////////////////////////////////			

			function sel_atyp()
			{
				satyp = document.getElementById('atyp').value;
				if (satyp > 0)
				{
					showHide('ahour', true);
					showHide('amin',  true);
					showHide('amel',  true);
					showHide('aon',   true);
				}
				else
				{
					showHide('ahour', false);
					showHide('amin',  false);
					showHide('amel',  false);
					showHide('aon',   false);
				}
			}
		  
			function sel_aact()
			{
				var saact = document.getElementById('aon').value;
				var satyp = document.getElementById('atyp').value;
			 
				if (saact == 0 && satyp > 0) showHide('amel',  true);
				else showHide('amel',  false);
			}

			function sel_anum()
			{
				var num = document.getElementById('anum').value;

				var xh = new XMLHttpRequest();
				xh.open("GET", "/jalarm", true);
				xh.send();
				xh.onreadystatechange = function()
				{
					if (this.readyState == 4 && this.status == 200) 
					{
						var res = JSON.parse(xh.responseText);
						document.getElementById('atyp'  ).value = res.al[num][0];
						document.getElementById('ahour' ).value = res.al[num][1];
						document.getElementById('amin'  ).value = res.al[num][2];
						document.getElementById('amel'  ).value = res.al[num][3];
						document.getElementById('aon'   ).value = res.al[num][4];

						sel_atyp();
						sel_aact();      		
					}
				}
			}
		  
			function time_ntp()
			{
				var xh = new XMLHttpRequest();
				xh.open('GET', '/ntp', true);
				xh.send(null);
				xh.onreadystatechange = function()
				{
					if (this.readyState == 4 && this.status == 200) loadValues();
				}      
			}

			function set_time()
			{
				h=document.getElementById('hour').value;
				m=document.getElementById('min').value;
				d=document.getElementById('day').value;
				mm=document.getElementById('mon').value;
				y=document.getElementById('year').value;
		  
				var url = '/set_time1?h='+h+'&m='+m+'&d='+d+'&mm='+mm+'&y='+y;
		  
				var xh = new XMLHttpRequest();
				xh.open('GET', url, true);
				xh.send(null);
			}
			
			function set_time_2()
			{
				var acorr = 0, upm = 0, ehb = 0, sndpol = 0, ledpol = 0;

				var tzone   = document.getElementById('tzone').value;
				if (document.getElementById('acorr').checked) acorr = 1;
				if (document.getElementById('upm').checked) upm = 1;
				var nmstart = document.getElementById('nmstart').value;
				var nmstop  = document.getElementById('nmstop').value;
				if (document.getElementById('ehb').checked) ehb = 1;
				var srtyp = document.getElementById('rtyp').value;
				var antp1 = document.getElementById('antp1').value;
				var antp2 = document.getElementById('antp2').value;
				var antp3 = document.getElementById('antp3').value;

				url = '/set_time2?tzone='+tzone+'&acorr='+acorr+'&upm='+upm+'&nmstart='+nmstart+'&nmstop='+nmstop+'&ehb='+ehb+'&srtyp='+srtyp+'&antp1='+antp1+'&antp2='+antp2+'&antp3='+antp3;

				var xh1 = new XMLHttpRequest();
				xh1.open('GET', url, true);
				xh1.send(null);
				xh1.onreadystatechange = function()
				{
					if (this.readyState == 4 && this.status == 200) loadValues();
				}      

				var sanum = document.getElementById('anum').value;
				var satyp = document.getElementById('atyp').value;
				var ahour = document.getElementById('ahour').value;
				var amin  = document.getElementById('amin').value;
				var samel = document.getElementById('amel').value;
				var saon  = document.getElementById('aon').value;
				
				url = '/set_alarm?sanum='+sanum+'&satyp='+satyp+'&ahour='+ahour+'&amin='+amin+'&samel='+samel+'&saon='+saon;
				
				var xh = new XMLHttpRequest();
				xh.open('GET', url, true);
				xh.send(null);
			}

			function showHide(element_id, visible) 
			{
				if (document.getElementById(element_id)) //Если элемент с id-шником element_id существует 
				{ 
					var obj = document.getElementById(element_id); //Записываем ссылку на элемент в переменную obj
					if (visible) obj.style.display = "inline-block"; //Показываем элемент
					else obj.style.display = "none"; //Скрываем элемент
				}
				else alert("Элемент с id: " + element_id + " не найден!"); //Если элемент с id-шником element_id не найден, то выводим сообщение
			}   

			function process()
			{
				var xh = new XMLHttpRequest();
				xh.open("GET", "/jactt", true);
				xh.send(null);
				xh.onreadystatechange = function()
				{
					if (this.readyState == 4 && this.status == 200) 
					{
						var res = JSON.parse(xh.responseText);
						document.getElementById('cur_time').value = res.tstr;
					}
				}

				var xh1 = new XMLHttpRequest();
				xh1.open("GET", "/jacta", true);
				xh1.send(null);
				xh1.onreadystatechange = function()
				{
					if (this.readyState == 4 && this.status == 200) 
					{
						var res1 = JSON.parse(xh1.responseText);
						if (res1.acth != 62) document.getElementById('act_hour').value = res1.acth;
						else document.getElementById('act_hour').value = "--";
						if (res1.actm != 62) document.getElementById('act_min' ).value = res1.actm;
						else document.getElementById('act_min').value = "--";
						
            if (res1.actw) sel_anum();
					}
				}
			}
			setInterval('process()',500);
			process();
		</script>
	</body>
</html>