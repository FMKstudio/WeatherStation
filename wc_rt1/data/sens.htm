<html>
  <head>
    <title>Wifi Clock Settings Sens</title>
    <meta http-equiv = 'content-type' content = 'text/html; charset = utf-8' />
    <style>
       body,td{font-family:tahoma,arial,helvetica,sans-serif;}
       table.t td.h{background-color:#C9C9C0;font-size:12px;font-weight:bold;text-align:center;}
       table.t td  {background-color:#E2E2DB;font-size:12px;text-align:center;}
    </style>
  </head>
  
  <body onload='loadValues();'>
    <table cellspacing='0' cellpadding='2' border='0' class='t' width='30%'>
  	<tr>
  	  <td align='center' class='h' width='5%'><a href='time.htm'>Time</a></td>
  	  <td align='center' class='h' width='5%'><a href='wifi.htm'>WiFi</a></td>
  	  <td align='center' class='h' width='5%'><a href='clock.htm'>Clock</a></td>
  	  <td align='center' class='h' width='5%'><a href='disp.htm'>Display</a></td>
  	  <td align='center' class='h' width='5%'><a href='sens.htm'>Sensor</a></td>
  	  <td align='center' class='h' width='5%'><a href='alarm.htm'>Alarm</a></td>
  	  <td align='center' class='h' width='5%'><a href='/edit'>Edit</a></td>
  	  <td align='center' class='h' width='5%'><a href='/exit'>Restart</a></td>
  	</tr>

    <tr><td colspan='8' height='20' align='center'><input type='text' id='cur_time' style='text-align:center;' readonly /></td></tr>
    </table>
  
    <table cellspacing='0' cellpadding='2' border='0' class='t' width='30%'>
      
      <tr><td colspan='2' class='h'>Опции</td></tr>
      <tr><td>city ID для GM и OWM</td><td><input type='text' size='6' id='cityID' name='cityID' style='text-align:center;' /></td></tr>
      <tr><td>OWM API Key</td><td><input type='text' size='32' id='owmk' name='owmk' style='text-align:center;' /></td></tr>
      <tr><td>Адрес внешн. сервера</td><td><input type='text' size='17' id='esaddr' name='esaddr' style='text-align:center;' /></td></tr>
      <tr><td>Адрес радиоприемничка</td><td><input type='text' size='17' id='rdaddr' name='rdaddr'  style='text-align:center;' /></td></tr>
      
      <tr><td width='35%'>Прогноз погоды</td>
      <td><select id='usepp' name='usepp' onclick='chk_pp();'>
      <option value = '0'>No_use</option>
      <option value = '1'>GM</option>
      <option value = '2'>OWM</option>
      </select></td></tr>

      <tr><td>WiFi включен постоянно</td><td><input type='checkbox' id='usees' name='usees'/></td></tr>
      
      <tr><td colspan='4' class='h'>Типы датчиков</td></tr>
      
      <tr><td width='35%'>Внешний</td>
        <td><select id='esnr' name='esnr'  onclick='sel_ts();'>
        <option value =  '0'>No_use</option>
        <option value =  '1'>TS</option>
        <option value =  '2'>Ext srv</option>
        <option value =  '3'>DHT21</option>
        <option value =  '4'>DS3231</option>
        <option value =  '5'>SI7021</option>
        <option value =  '6'>AM2320</option>
        <option value =  '7'>BMP180</option>
        <option value =  '8'>BMP280</option>
        <option value =  '9'>BME280</option>
        <option value = '10'>Из прогноза</option>
        </select></td></tr>
      
      <tr><td width='35%'>Внутренний</td>
        <td><select id='isnr' name='isnr' onclick='sel_ts();'>
        <option value =  '0'>No_use</option>
        <option value =  '1'>TS</option>
        <option value =  '2'>Ext srv</option>
        <option value =  '3'>DHT21</option>
        <option value =  '4'>DS3231</option>
        <option value =  '5'>SI7021</option>
        <option value =  '6'>AM2320</option>
        <option value =  '7'>BMP180</option>
        <option value =  '8'>BMP280</option>
        <option value =  '9'>BME280</option>
        <option value = '10'>Из прогноза</option>
        </select></td></tr>
      
      <tr><td width='35%'>Давления</td>
        <td><select id='psnr' name='psnr' onclick='sel_ts();'>
        <option value =  '0'>No_use</option>
        <option value =  '1'>TS</option>
        <option value =  '2'>Ext srv</option>
        <option value =  '7'>BMP180</option>
        <option value =  '8'>BMP280</option>
        <option value =  '9'>BME280</option>
        <option value = '10'>Из прогноза</option>
       </select></td></tr>

      <tr><td>Период опроса (мин)</td><td><input type='text' size='2' id='period' name='period' style='text-align:center;'/></td></tr>

      <tr><td colspan='2' class='h'>Текущие показания</td></tr>

        <tr><td width='20%'>Температура</td><td>
        &nbsp;снаружи&nbsp;<input type='text' maxlength='2' size='1' id='cur_t2' name='cur_t2' style='text-align:center;' readonly />&nbsp;внутри&nbsp;
        <input type='text' maxlength='2' size='1' id='cur_t1' name='cur_t1'  style='text-align:center;'/></td></tr>
        <tr><td width='20%'>Влажность</td><td>
        &nbsp;снаружи&nbsp;<input type='text' maxlength='2' size='1' id='cur_h2' name='cur_h2' style='text-align:center;' readonly />&nbsp;внутри&nbsp;
        <input type='text' maxlength='2' size='1' id='cur_h1' name='cur_h1'  style='text-align:center;'/></td></tr>
        <tr><td>Давление</td><td>&nbsp;---------------------&nbsp;<input type='text' size='3' id='cur_p' name='cur_p'  style='text-align:center;' readonly /></td></tr>
    
      <tr><td colspan='4' class='h'>Параметры аккаунта ТS:</td></tr>

        <tr><td>Channel ID</td><td><input type='text' size='6' id='tschan' name='tschan' style='text-align:center;' /></td></tr>
        <tr><td>API key R</td><td><input type='text' size='17' id='tsapir' name='tsapir' style='text-align:center;' /></td></tr>
        <tr><td>API key W</td><td><input type='text' size='17' id='tsapiw' name='tsapiw' style='text-align:center;' /></td></tr>
    
      <tr><td colspan='4' class='h'>Отправка показаний на ТS с датчиков:</td></tr>

        <tr><td>Внутреннего</td><td><input type='checkbox' id='utsi' name='utsi' onclick='sel_ts();'/></td></tr>
        <tr><td>Внешнего   </td><td><input type='checkbox' id='utse' name='utse' onclick='sel_ts();'/></td></tr>
        <tr><td>Давления   </td><td><input type='checkbox' id='utsp' name='utsp' onclick='sel_ts();'/></td></tr>
  
      <tr><td colspan='4' class='h'><input type='submit' value='Записать' onclick='set_pars();' /></td></tr>
  
    </table>
  
    <script>

      function loadValues()
      {
        var xh = new XMLHttpRequest();
        xh.open("GET", "/jsens", true);
        xh.onreadystatechange = function()
        {
          if (xh.readyState == 4 && xh.status == 200) 
          {
            var res = JSON.parse(xh.responseText);
            document.getElementById('cityID').value = res.cyid;
            document.getElementById('esaddr').value = res.srve;
            document.getElementById('rdaddr').value = res.srvr;
            document.getElementById('period').value = res.peri;
            document.getElementById('esnr').value   = res.exts;
            document.getElementById('isnr').value   = res.ints;
            document.getElementById('psnr').value   = res.prss;
            document.getElementById('usepp').value  = res.prgp;
            document.getElementById('usees').checked = res.srvp;
            document.getElementById('owmk').value   = res.owmk;

            chk_pp();
            
    	    }
        }
        xh.send(null);
        loadTs();
      }
      
      function loadTs()
      {
        var xh = new XMLHttpRequest();
        xh.open("GET", "/jts", true);
        xh.onreadystatechange = function()
        {
          if (xh.readyState == 4 &&  xh.status == 200) 
          {
            var res = JSON.parse(xh.responseText);
            document.getElementById('utsi').checked = res.tssi;
            document.getElementById('utse').checked = res.tsse;
            document.getElementById('utsp').checked = res.tssp;
            document.getElementById('tschan').value = res.tsid;
            document.getElementById('tsapir').value = res.tsar;
            document.getElementById('tsapiw').value = res.tsaw;
          
            sel_ts();
          }   	  
        }
        xh.send(null);
        loadSnr();
      }
      
      function loadSnr()
      {
        var xh = new XMLHttpRequest();
        xh.open("GET", "/jsnr", true);
        xh.onreadystatechange = function()
        {
          if (xh.readyState == 4 &&  xh.status == 200) 
          {
            var res = JSON.parse(xh.responseText);
            document.getElementById('cur_t1').value = res.tint;
            document.getElementById('cur_t2').value = res.text;
            document.getElementById('cur_h1').value = res.hint;
            document.getElementById('cur_h2').value = res.hext;
            document.getElementById('cur_p' ).value = res.pres;
    	    }
        }
        xh.send(null);
      }
    

      function showHide(element_id, visible) 
      {
      //Если элемент с id-шником element_id существует
        if (document.getElementById(element_id)) 
        { 
          //Записываем ссылку на элемент в переменную obj
          var obj = document.getElementById(element_id); 
          if (visible) obj.style.display = "inline-block"; //Показываем элемент
          else obj.style.display = "none"; //Скрываем элемент
        }
        //Если элемент с id-шником element_id не найден, то выводим сообщение
        else alert("Элемент с id: " + element_id + " не найден!"); 
      }   

      function process()
      {
        var xh = new XMLHttpRequest();
        xh.open("GET", "/jact", true);
        xh.onreadystatechange = function()
        {
          if (xh.readyState == 4 && xh.status == 200) 
          {
            var res = JSON.parse(xh.responseText);
            document.getElementById('cur_time').value = res.tstr;
            document.getElementById('cur_t1').value = res.tint;
            document.getElementById('cur_t2').value = res.text;
            document.getElementById('cur_h1').value = res.hint;
            document.getElementById('cur_h2').value = res.hext;
            document.getElementById('cur_p' ).value = res.pres;
          }
        }
        xh.send(null);
        setTimeout('process()',500);
      }

      
      function set_pars()
      {
        var utsi_t = 0, utse_t = 0, utsp_t = 0, usees_t = 0;

        if (document.getElementById('utsi').checked) utsi_t = 1;
        if (document.getElementById('utse').checked) utse_t = 1;
        if (document.getElementById('utsp').checked) utsp_t = 1;
        tschan_t = document.getElementById('tschan').value;
        tsapir_t = document.getElementById('tsapir').value;
        tsapiw_t = document.getElementById('tsapiw').value;
        cityID_t = document.getElementById('cityID').value;
        esaddr_t = document.getElementById('esaddr').value;
        rdaddr_t = document.getElementById('rdaddr').value;
        period_t = document.getElementById('period').value;
        if (document.getElementById('usees').checked) usees_t = 1;
        usepp_t  = document.getElementById('usepp').value;
        esnr_t   = document.getElementById('esnr').value;
        isnr_t   = document.getElementById('isnr').value;
        psnr_t   = document.getElementById('psnr').value;
        owmk_t   = document.getElementById('owmk').value;

        url='/set_pars?utsi_t=' + utsi_t   + '&utse_t='   + utse_t   + '&utsp_t='   + utsp_t   + '&tschan_t=' + tschan_t 
                 + '&tsapir_t=' + tsapir_t + '&tsapiw_t=' + tsapiw_t + '&cityID_t=' + cityID_t + '&esaddr_t=' + esaddr_t
                 + '&rdaddr_t=' + rdaddr_t + '&period_t=' + period_t + '&usees_t='  + usees_t  + '&usepp_t='  + usepp_t
                 + '&esnr_t='   + esnr_t   + '&isnr_t='   + isnr_t   + '&psnr_t='   + psnr_t   + '&owmk_t='   + owmk_t;

        var xh = new XMLHttpRequest();
        xh.open('GET', url, true);
        xh.onreadystatechange = function()
        {
          if (xh.readyState==4 && xh.status==200) loadValues();
        }      
        xh.send(null);
      }
      
      function sel_ts()
      {
        var utsi_t = 0, utse_t = 0, utsp_t = 0;

        if (document.getElementById('utsi').checked) utsi_t = 1;
        if (document.getElementById('utse').checked) utse_t = 1;
        if (document.getElementById('utsp').checked) utsp_t = 1;
         
         if (utsi_t == 1 || utse_t == 1 || utsp_t == 1) showHide('tsapiw',  true);
         else showHide('tsapiw',  false);

        esnr_t   = document.getElementById('esnr').value;
        isnr_t   = document.getElementById('isnr').value;
        psnr_t   = document.getElementById('psnr').value;

/////////////////////////////////// For TS
         if (esnr_t == 1 || isnr_t == 1 || psnr_t == 1) showHide('tsapir',  true);
         else showHide('tsapir',  false);

         if (esnr_t == 1 || isnr_t == 1 || psnr_t == 1 || utsi_t == 1 || utse_t == 1 || utsp_t == 1) showHide('tschan',  true);
         else showHide('tschan',  false);

/////////////////////////////////// For ES
         if (esnr_t == 2 || isnr_t == 2 || psnr_t == 2) showHide('esaddr',  true);
         else showHide('esaddr',  false);

/////////////////////////////////// For NotUse
         if (isnr_t > 0) 
         {
           showHide('cur_t1',  true);
           showHide('cur_h1',  true);
         }
         else 
         {
           showHide('cur_t1',  false);
           showHide('cur_h1',  false);
         }

         if (esnr_t > 0) 
         {
           showHide('cur_t2',  true);
           showHide('cur_h2',  true);
         }
         else 
         {
           showHide('cur_t2',  false);
           showHide('cur_h2',  false);
         }
         if (psnr_t > 0) 
         {
           showHide('cur_p',  true);
           showHide('cur_p',  true);
         }
         else 
         {
           showHide('cur_p',  false);
           showHide('cur_p',  false);
         }
      }
      
      function chk_pp()
      {
         usepp_t  = document.getElementById('usepp').value;
         
         if (usepp_t > 0 ) showHide('cityID',  true);
         else showHide('cityID',  false);

         if (usepp_t == 2 ) showHide('owmk',  true);
         else showHide('owmk',  false);
      }
      
      process();
      
    </script>
  </body>
</html>
